name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server with Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd /root/MERN-template

            echo "üîÑ Pulling latest code..."
            git pull origin main

            echo "üê≥ Stopping existing containers..."
            docker compose -f docker-compose.production.yml down || true

            echo "üßπ Cleaning up old images..."
            docker image prune -f

            echo "üèóÔ∏è Building and starting containers..."
            docker compose -f docker-compose.production.yml --env-file .env.production up -d --build

            echo "‚è≥ Waiting for services to start..."
            sleep 20

            echo "‚úÖ Checking container status..."
            docker compose -f docker-compose.production.yml ps

            echo "üè• Running health checks..."
            echo "Main App:"
            curl -sf http://localhost:3000/health && echo " ‚úÖ OK" || echo " ‚ö†Ô∏è Failed"
            echo "Auth Service:"
            curl -sf http://localhost:3100/health && echo " ‚úÖ OK" || echo " ‚ö†Ô∏è Failed"
            echo "News Service:"
            curl -sf http://localhost:3200/health && echo " ‚úÖ OK" || echo " ‚ö†Ô∏è Failed"
            echo "Chat Service:"
            curl -sf http://localhost:3300/health && echo " ‚úÖ OK" || echo " ‚ö†Ô∏è Failed"
            echo "Economy Service:"
            curl -sf http://localhost:3400/health && echo " ‚úÖ OK" || echo " ‚ö†Ô∏è Failed"

            echo "üìä Container resource usage..."
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

            echo "üéâ Deployment complete!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
