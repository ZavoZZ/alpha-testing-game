name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create database backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            BACKUP_DIR="/root/backups"
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BACKUP_PATH="$BACKUP_DIR/backup-$TIMESTAMP"
            
            echo "üì¶ Creating backup at $BACKUP_PATH..."
            mkdir -p $BACKUP_DIR
            
            # Create MongoDB backup
            mongodump --out $BACKUP_PATH
            
            # Compress backup
            cd $BACKUP_DIR
            tar -czf backup-$TIMESTAMP.tar.gz backup-$TIMESTAMP
            rm -rf backup-$TIMESTAMP
            
            echo "‚úÖ Backup created: backup-$TIMESTAMP.tar.gz"
            
            # Keep only last 7 days of backups
            find $BACKUP_DIR -name "backup-*.tar.gz" -mtime +7 -delete
            
            echo "üìä Current backups:"
            ls -lh $BACKUP_DIR/backup-*.tar.gz
      
      - name: Notify backup status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Backup successful!"
          else
            echo "‚ùå Backup failed!"
          fi
